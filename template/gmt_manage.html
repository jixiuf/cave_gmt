{% extends base.html %}
{% block css%}
<link href="../static/dist/gmt_manage.css" rel="stylesheet" type="text/css"/>
{% end %}
{% block body %}
<div class="ui-manage-form">
    <h2 class="form-signin-heading ui-manage-title">账号管理</h2>
    <form class="form-horizontal" role="form">
        <div class="form-group">
            <label class="col-sm-2 control-label">GM账号</label>
            <div class="col-sm-10">
                <select class="form-control op-level-account" id="inputEmail3" placeholder="账号" >
                    <option value=''>下拉选择GM账号</option>
                    {% for gmAccount in gmAccountList %}
                    <option value='{{ escape(gmAccount.account) }}'>{{ escape(gmAccount.account) }}</option>
                    {% end %}
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">GM权限</label>
            <div class="col-sm-10">
                <select class="form-control ui-select op-level-select">
                    <option>下拉选择权限等级</option>
                    {% for permissionLevel in permissionLevelList %}
                    <option value='{{permissionLevel.level}}'>{{ escape(permissionLevel.levelDesc)}}</option>
                    {% end %}
                </select>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
                <button type="submit" class="btn btn-default op-level-submit">修改权限</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <button type="submit" class="btn btn-default op-delete">删除账号</button>
            </div>
        </div>
        <div class='ui-msg'>
            {{ msg }}
        </div>
    </form>
</div>
<script type="text/javascript">
    var selectEl = $('.op-level-select'),
        accountEl = $('.op-level-account'),
        updateEl = $('.op-level-submit'),
        deleteEl = $('.op-delete'),
        ajaxing = false,
        data = {};


    updateEl.on('click', function() {
        if(ajaxing || selectEl.val().length != 1||accountEl.val()=="") return false;
        ajaxing = true;
        data['account'] = accountEl.val();
        data['level'] = selectEl.val();
        $.ajax({
            url: '/api/account/update_level',
            type: 'post',
            data: data
        })
        .done(function(data) {
            ajaxing = false;
            if(data == 'wrong permissions') {
                location.href = '/?msg=原页面无权限访问，跳转到此';
                alert(data);
            } else {
                data = JSON.parse(data);
            }

            if(data.action == 'success') {
                alert('账号权限修改成功！');
            } else if(data.action == 'no account') {
                alert('该账号不存在！');
            }
        });
        return false;
    });
    deleteEl.on('click', function() {
        if(ajaxing || accountEl.val()=="") {
            alert("请选择账号");
            return false;
        }
        ajaxing = true;
        data['account'] = accountEl.val();
        data['delete'] = "true";
        $.ajax({
            url: '/api/account/update_level',
            type: 'post',
            data: data
        })
        .done(function(data) {
            ajaxing = false;
            if(data == 'wrong permissions') {
                location.href = '/?msg=原页面无权限访问，跳转到此';
                alert(data);
            } else {
                data = JSON.parse(data);
            }

            if(data.action == 'success') {
                window.location.reload();
                alert('删除权限修改成功！');
            } else if(data.action == 'no account') {
                alert('该账号不存在！');
            }
        });
        return false;
    });
 

</script>
{% end %}
